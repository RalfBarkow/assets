<div id=result>working</div>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'

  const context = await frame.context()
  const roster = context.page.story.find(item => item.type == 'roster')
  const sites = roster.text.split(/\n/).filter(line => line.match(/^[a-z0-9\.-]+$/))
  window.result.innerHTML = `${sites.length} sites`

  const domain = Symbol('domain')
  const sitemaps = await Promise.all(sites.map(site =>
    fetch(`https://${site}/system/sitemap.json`)
      .then(res => res.json()
      .then(json => {json[domain] = site; return json}))))
  for (const map of sitemaps)
    for (const info of map)
      info.site = map[domain]
  const count = sitemaps.reduce((count,map) => count+map.length,0)
  window.result.innerHTML += `<br>${count} pages`

  const property = / (Category|Zone|Landscape|Family): ([\w\d]+)/g
  const haves = sitemaps
    .map(sitemap => sitemap.filter(info => info.synopsis.match(property)))
    .flat()
  window.result.innerHTML += `
    <br>${haves.length} annotated
    <p><button onclick=dopreview(event)>preview</button></p>`

  window.dopreview = event => {
    const title = "Project Weave Diagram"
    const text = haves
      .map(info => {
        const synopsis = info.synopsis
        const have = [...synopsis.matchAll(property)]
        const props = have
          .map(m => {
            const key = m[1]
            const value = m[2]
            return `&nbsp ${key}: ${value}`
          })
          .join("<br>")
        return `
          <img width=16 src=https://${info.site}/favicon.png>
          [https://${info.site}/${info.slug}.html ${info.title}]
          <br>
          ${props}`
      })
      .join("<hr>")
    const story = [
      {type:'paragraph',text:`Update with [[${context.title}]]`},
      {type:'html',text}
    ]
    frame.open({title,story},event.shiftKey)
  }

</script>