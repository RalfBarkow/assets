<p>
  <select id="indexEntries"></select>
  <select id="paragraphEntries"></select>
  <button onclick=dostart(event)>start</button>
  <span id=startat></span>
</p>
<pre id="result"></pre>
<script type="module">

 import {visit,getfrom,sitemaps} from './telling.js'
 import {open, context} from 'http://code.fed.wiki/assets/v1/frame.js'
 import {Graph} from 'https://wardcunningham.github.io/graph/graph.js';

 const graph = new Graph();
 const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
 const any = list => list[Math.floor(Math.random()*list.length)]
 const hsv = hue => `"${(hue%1).toFixed(3)} 0.2 1.0"`
 const quote = title => `"${title.replace(/ +/g,'\\n')}"`

 let done = Date.now() + 10000

 let all = [await getfrom('a',['wiki.ralfbarkow.ch'])]
 let reference = (await context()).page.story.find(item => item.type == 'reference')
 if(reference) {
     all = [await getfrom(reference.slug,[reference.site])]
 }
 window.startat.innerText = all[0].page.title
 let pick = all[0]
 let seen = new Set([pick.page.title])
 let dot = []
 let hue = 0.5001
 let color = {} // site => hsv
 addPageTitleToGraphviz(pick)
 populateIndexEntries(seen)

 function addPageTitleToGraphviz(pick) {
     let title = pick.page.title
     let site = pick.site
     let sites = pick.sites
     color[site] ||= hsv(hue += 0.111)

     dot.push(addTitleDot(title, site, sites, color));
     /*
        Ward is introducing page titles to Graphviz.
        This is where he associates a color to be used where ever he mentions that title.
      */
 }

 function addTitleDot(title, site, sites, color) {
     console.log("addTitleDot reached")

     const nodeProperties = {
         tooltip: `${site}\n\n${sites.join("\n")}`,
         fillcolor: color[site]
     };

     // Check if the node already exists in the graph
     const existingNode = graph.nodes.find(node => node.type === title);
     if (existingNode) {
         console.log(`Node with title '${title}' already exists in the graph.`);
     } else {
         // Add the node to the graph
         const node = graph.addNode(title, nodeProperties);

         // Check if the node was successfully added
         if (node) {
             console.log(`Node "${title}" added to the graph with ID ${node.id}`);
         } else {
             console.error(`Failed to add node "${title}" to the graph`);
         }
     }

     console.log("Updated graph:", graph.stringify(null, 2)); // Output the updated graph

     // Construct the DOT node string with the extracted color
     return `${quote(title)} [ tooltip="${site}\n\n${sites.join("\n")}" fillcolor=${color[site]}]`;
     /*
        Ward introduced "dot" and "quote" nine years ago.
        See http://gd.fed.wiki/view/dump-a-structure-into-graphviz
      */
 }

 function joinTitlesDot(pick, next){
     return `${quote(pick.page.title)} -> ${quote(next.page.title)}`
     /*
        Here Ward is emitting the literal string, " -> ", with quoted titles on either side.
        He prefers small words for variable names when the variable has been defined in close proximity.
        The words "dot" and "quote" are an exception.
        He has been using both words with specific meaning for many years.
        He wrote about this here: http://gd.fed.wiki/view/dump-a-structure-into-graphviz
      */
 }

 function populateIndexEntries(seen) {
     let indexEntries = seen
     let select = document.getElementById('indexEntries')

     // Clear existing options
     select.innerHTML = '';

     indexEntries.forEach(entry => {
         let option = document.createElement('option')
         option.text = entry
         select.add(option)
     })
 }

 function filterParagraphs(page) {
     let _paragraphs = page.story.filter(item => item.type === 'paragraph');
     populateParagraphEntries(_paragraphs)
     return _paragraphs;
 }

 function populateParagraphEntries(paragraphs) {
     let select = document.getElementById('paragraphEntries')

     // Clear existing options
     select.innerHTML = '';

     paragraphs.forEach(entry => {
         let optgroup = document.createElement('optgroup');
         optgroup.label = entry.id;

         let option = document.createElement('option')
         option.value = entry.id;
         option.text = entry.text

         //select.add(option)
         optgroup.appendChild(option);
         select.appendChild(optgroup);
     })
 }


 function setStartEntry() {
     const select = document.getElementById('indexEntries');
     const selectedEntry = select.value;
     console.log('Selected Entry:', selectedEntry);

     // Find the selected entry in the `seen` Set
     for (let entry of seen) {
         if (entry === selectedEntry) {
             // Update the start entry and display it
             window.startat.innerText = entry;
             console.log('Start Entry:', entry);
             break;
         }
     }
 }

 // Attach the setStartEntry function to the change event of the select element
 document.getElementById('indexEntries').addEventListener('change', setStartEntry);
 document.getElementById('paragraphEntries').addEventListener('change', setStartEntry);


 window.doview = function (event) {
     let [site,title] = event.target.innerText.split(' — ')
     window.parent.postMessage({
         action:"doInternalLink",
         title,
         site,
         keepLineup: event.shiftKey
     }, "*")
 }

 window.dostart = async function (event) {
     done = Date.now() + 10000
     window.result.innerText = ''

     // Check if a start entry is selected
     const selectedStartEntry = document.getElementById('indexEntries').value;
     if (selectedStartEntry) {
         // Set the start entry based on the selected entry
         pick = all.find(entry => entry.page.title === selectedStartEntry);
     } else {
         // Use the default start entry
         pick = all[0];
     }

     seen = new Set([pick.page.title])
     addPageTitleToGraphviz(pick)
     console.log('Start: pick.page', pick.page);

     try {
         while (Date.now() < done) {
             let remain = Math.ceil((done - Date.now())/1000);
             let paragraphs = filterParagraphs(pick.page);
             for (let paragraph of paragraphs) {
                 let links = visit(pick.page).filter(title => !seen.has(title))
                 if (links.length) {
                     let link = any(links)
                     seen.add(link)
                     populateIndexEntries(seen)
                     let next = await getfrom(asSlug(link),pick.sites)
                     if (next && next.page) {
                         addPageTitleToGraphviz(next)

                         // Create relations, arrows, between titles already introduced
                         dot.push(joinTitlesDot(pick, next))

                         all.push(next)
                         window.result.innerHTML += `${remain} <span onclick=doview(event)>${next.site} — ${link}</span>\n`
                         pick = next
                     } else {
                         window.result.innerHTML += `  <span style="color:gray;">fail ${link}</span>\n`
                     }
                 } else {
                     all = all.filter(place => !(place.site == pick.site && place.page.title == pick.page.title))
                     if (!all.length) break
                     window.result.innerHTML += `  <span style="color:gray;">done ${pick.page.title}</span>\n`
                     pick = any(all) // can't find new link on page
                 }
             }
         }
     }
     catch(err) {
         window.result.innerHTML += `
  ${err.message}
  ${err.stack}`
     }

     window.result.innerHTML += "\n\n"+Object.entries(sitemaps).map(([site,infos]) => `${infos.length} — ${site}`).join("\n")
     let dotText = `digraph {\nnode [shape=box style=filled fillcolor=white]\n${dot.join("\n")}\n}`
     let story = [
         {type:'paragraph', text: `Random journey rooted from ${reference.title} and proceeding for ${all.length} pages travelling through ${Object.keys(color).length} sites.`},
         {type:'graphviz', text:dotText}
     ]

     openSpeedBotJourney(story, event.shiftKey);

 }

 function openSpeedBotJourney(story, shiftKey) {
     open({ title: "Speed Bot Journey", story }, shiftKey, Object.keys(color));
 }

</script></body></html>
