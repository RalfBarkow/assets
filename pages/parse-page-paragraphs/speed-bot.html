<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Bot</title>
</head>

<body>
    <p>
        <label for="indexEntries">Page:</label><select id="indexEntries"></select>
        <label for="paragraphEntries">Paragraph:</label><select id="paragraphEntries"></select>
        <button onclick=dostart(event) type="submit">start</button>
        <span id=startat></span>
    </p>
    <pre id="result"></pre>
    <script type="module">

        // Import necessary modules and classes
        import { Graph } from 'https://wardcunningham.github.io/graph/graph.js';
        import { visit, getfrom, sitemaps } from './telling.js'
        import { open, context } from 'http://code.fed.wiki/assets/v1/frame.js'

        // Define a module for the application
        const SpeedBotApp = (() => {
            // Private variables and functions
            let graph;
            let all;
            let reference;
            let pick;
            let seen;
            let dot;
            let hue;
            let color;
            let done; // Initialize done here

            // Initialize the application
            async function init() {
                graph = new Graph();
                color = {};
                dot = [];
                hue = 0.5001;
                done = Date.now() + 10000;

                all = [await getfrom('a', ['wiki.ralfbarkow.ch'])]
                reference = (await context()).page.story.find(item => item.type == 'reference')
                if (reference) {
                    all = [await getfrom(reference.slug, [reference.site])]
                }

                window.startat.innerText = all[0].page.title;
            }

            // Private function to add page title to graphviz
            function addPageTitleToGraphviz(pick) {
                console.log("addPageTitleToGraphviz reached")

                let title = pick.page.title
                let site = pick.site
                let sites = pick.sites
                const hsv = hue => `"${(hue % 1).toFixed(3)} 0.2 1.0"`
                color[site] ||= hsv(hue += 0.111)

                dot.push(addTitleDot(title, site, sites, color));
                /*
                   Ward is introducing page titles to Graphviz.
                   This is where he associates a color
                   to be used where ever he mentions that title.
                 */
            }

            function setStartEntry() {
                const select = document.getElementById('indexEntries');
                const selectedEntry = select.value;
                console.log('Selected Entry:', selectedEntry);

                // Find the selected entry in the `seen` Set
                for (let entry of seen) {
                    if (entry === selectedEntry) {
                        // Update the start entry and display it
                        window.startat.innerText = entry;
                        console.log('Start Entry:', entry);
                        break;
                    }
                }
            }

            function quote(title) {
                // const quote = title => `"${title.replace(/ +/g,'\\n')}"`
                return `"${title.replace(/ +/g, '\\n')}"`;
            }

            function addTitleDot(title, site, sites, color) {

                const nodeProperties = {
                    tooltip: `${site}\n\n${sites.join("\n")}`,
                    fillcolor: color[site]
                };

                addTitle(title, nodeProperties);

                // Construct the DOT node string with the extracted color
                return `${quote(title)} [ tooltip="${site}\n\n${sites.join("\n")}" fillcolor=${color[site]}]`;
                /*
                   See http://gd.fed.wiki/view/dump-a-structure-into-graphviz
                 */
            }

            function nodeIndex(title) {
                console.log("nodeIndex reached");

                // Check if the node already exists in the graph
                const nodeId = graph.nodes.findIndex(node => node.type === title);
                return nodeId;
            }

            function addTitle(title, nodeProperties) {
                console.log("addTitle reached");

                // Check if the node already exists
                const foundNodeId = nodeIndex(title);

                if (foundNodeId !== -1) {
                    console.log(`Node with title '${title}' (${foundNodeId}) already exists`);
                    return foundNodeId;
                }

                // Add the node to the graph
                const newNodeId = graph.addNode(title, 0, 0, nodeProperties);

                // Check if the node was successfully added
                if (!newNodeId) return null;

                console.log(`Node "${title}" (${newNodeId}) added`);
                serializeGraphAsJSONL(graph);
                console.log("addTitle returns new nodeId ", newNodeId);
                return newNodeId;
            }

            // Serialize the entire Graph object as one JSON line in a JSONL stream
            function serializeGraphAsJSONL(graph) {
                console.log("serializeGraphAsJSONL reached")

                broadcast(JSON.stringify(graph) + '\n');
            }

            // postMessage
            function broadcast(graph) {
                console.log("broadcast reached")

                const targetOrigin = "*" // "*" indicates that the message can be received from any origin

                // Post a message to the parent window
                window.parent.postMessage(
                    // message
                    // See https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage
                    {
                        action: "publishSourceData", // graphStream
                        name: "graph",
                        sourceData: { graph }
                    },
                    targetOrigin // optional
                );
            }

            function joinTitlesDot(pick, next) {
                joinTitles(pick, next);
                return `${quote(pick.page.title)} -> ${quote(next.page.title)}`
                /*
                   See http://gd.fed.wiki/view/dump-a-structure-into-graphviz
                 */
            }

            function joinTitles(pick, next) {
                console.log("joinTitles reached");

                const fromIndex = graph.nodes.findIndex(node => node.type === pick.page.title);
                const toIndex = addTitle(next.page.title, {}); // Add next page title if it doesn't exist and get its index
                if (toIndex !== -1) {
                    graph.addRel('fromPickToNext', fromIndex, toIndex, {});
                    console.log(`fromPickToNext: Relation added from "${pick.page.title}" (${fromIndex}) -> to "${next.page.title}" (${toIndex})`);
                    serializeGraphAsJSONL(graph);
                }
            }

            function populateIndexEntries(seen) {
                let indexEntries = seen
                let select = document.getElementById('indexEntries')

                // Clear existing options
                select.innerHTML = '';

                indexEntries.forEach(entry => {
                    let option = document.createElement('option')
                    option.text = entry
                    select.add(option)
                })
            }

            function filterParagraphs(page) {
                let _paragraphs = page.story.filter(item => item.type === 'paragraph');
                populateParagraphEntries(_paragraphs, page.title)
                return _paragraphs;
            }

            function populateParagraphEntries(paragraphs, title) {
                console.log("populateParagraphEntries reached");

                let select = document.getElementById('paragraphEntries');

                // Clear existing options
                select.innerHTML = '';

                // Get the id of a node named title
                const pageId =
                    graph.nodes.findIndex(node => node.type === title);

                paragraphs.forEach(entry => {
                    // Check if the relation already exists
                    const existingRel =
                        graph.rels.findIndex(rel => rel.type === 'fromParaToPage' && rel.from === entry.id && rel.to === title);
                    if (existingRel !== -1) {
                        // Relation already exists
                        console.log(`fromParaToPage: Relation between paragraph ${entry.id} (${existingRel}) and title "${title}" (${pageId}) already exists.`);
                    } else {

                        // Relation does not exist, so add it
                        const paraId =
                            graph.addNode(entry.id, { text: entry.text });
                        graph.addRel('fromParaToPage', paraId, pageId, entry.id, title, {});
                        console.log(`fromParaToPage: Relation between paragraph ${entry.id} (${paraId}) and title "${title}" (${pageId}) added to the graph.`);
                        serializeGraphAsJSONL(graph)
                    }

                    // Create an option for the paragraph entry in the dropdown list
                    let optgroup = document.createElement('optgroup');
                    optgroup.label = entry.id;

                    let option = document.createElement('option')
                    option.value = entry.id;
                    option.text = entry.text

                    //select.add(option)
                    optgroup.appendChild(option);
                    select.appendChild(optgroup);
                })
            }

            window.doview = function (event) {
                let [site, title] = event.target.innerText.split(' — ')
                window.parent.postMessage({
                    action: "doInternalLink",
                    title,
                    site,
                    keepLineup: event.shiftKey
                }, "*")
            }

            async function handleParagraphs(paragraphs, pick, remain) {
                for (let paragraph of paragraphs) {
                    let links = visit(pick.page).filter(title => !seen.has(title));

                    if (links.length) {
                        let link = any(links);
                        seen.add(link);
                        populateIndexEntries(seen);
                        let next = await getfrom(asSlug(link), pick.sites);

                        if (next && next.page) {
                            addPageTitleToGraphviz(next);
                            dot.push(joinTitlesDot(pick, next));
                            all.push(next);
                            window.result.innerHTML += `${remain} <span onclick=doview(event)>${next.site} — ${link}</span>\n`;
                            pick = next;
                        } else {
                            window.result.innerHTML += `  <span style="color:gray;">fail ${link}</span>\n`;
                        }
                    } else {
                        handleNoLinks(pick);
                    }
                }
            }

            window.dostart = async function (event) {
                done = Date.now() + 10000
                window.result.innerText = ''

                const selectedStartEntry = document.getElementById('indexEntries').value;
                const pick = selectedStartEntry ? all.find(entry => entry.page.title === selectedStartEntry) : all[0];
                seen = new Set([pick.page.title]);
                addPageTitleToGraphviz(pick);
                console.log('Start: pick.page', pick.page);

                try {
                    while (Date.now() < done) {
                        let remain = Math.ceil((done - Date.now()) / 1000);
                        let paragraphs = filterParagraphs(pick.page);
                        await handleParagraphs(paragraphs, pick, remain); // await ?
                    }
                } catch (err) {
                    window.result.innerHTML += `${err.message}\n${err.stack}`;
                }

                displayResultSummary();
            };

            function handleNoLinks(pick) {
                all = all.filter(place => !(place.site == pick.site && place.page.title == pick.page.title));
                if (!all.length) {
                    window.result.innerHTML += `  <span style="color:gray;">done ${pick.page.title}</span>\n`;
                    return true; // Indicates that the loop should break
                }
                pick = any(all); // can't find new link on page
                return false; // Indicates that the loop should continue
            }

            function displayResultSummary(event) {
                window.result.innerHTML += "\n\n" + Object.entries(sitemaps).map(([site, infos]) => `${infos.length} — ${site}`).join("\n");
                const dotText = `digraph {\nnode [shape=box style=filled fillcolor=white]\n${dot.join("\n")}\n}`;
                const story = [
                    { type: 'paragraph', text: `Random journey rooted from ${reference.title} and proceeding for ${all.length} pages travelling through ${Object.keys(color).length} sites.` },
                    { type: 'graphviz', text: dotText }
                ];
                openSpeedBotJourney(story, event && event.shiftKey); // Check if event is defined before accessing shiftKey
            }

            function any(array) {
                // const any = list => list[Math.floor(Math.random()*list.length)]
                return array[Math.floor(Math.random() * array.length)];
            }

            function asSlug(title) {
                // const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
                return title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase();
            }

            function openSpeedBotJourney(story, shiftKey) {
                open({ title: "Speed Bot Journey", story }, shiftKey, Object.keys(color));
            }

            // Public method to start the application
            function start() {
                init();
                // Attach setStartEntry function to the change event of the select element
                document.getElementById('indexEntries').addEventListener('change', setStartEntry);
                document.getElementById('paragraphEntries').addEventListener('change', setStartEntry);
            }

            // Public API
            return {
                start
            };
        })();

        // Initialize and start the application
        SpeedBotApp.start();

    </script>
</body>

</html>