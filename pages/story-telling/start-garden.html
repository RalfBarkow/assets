<p>
  <button onclick=dostart(event)>start garden</button>
  <input id=title type=text width=80 placeholder="Optional Garden Title">
</p>
<div id=menu></div>
<div id=result></div>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  import {folded, linked} from './telling.js'
  const wordcount = story => story.reduce((sum,item) => sum + (item.text||'').split(/\s+/).length, 0)
  const uniq = (value, index, self) => self.indexOf(value) === index

  window.menu.innerHTML = (await frame.context()).page.story
    .filter(item => item.type == 'reference')
    .map(ref => `
      <input type="checkbox" id="${ref.title}" name="ref">
      <label for="${ref.title}">${ref.title}</label><br>`).join("\n")

  window.dostart = function(event) {
    let selected = [...menu.querySelectorAll('input')]
      .filter(input => input.checked)
      .map(input => input.id)
    start(event,selected)
  }

  async function start(event,selected) {
    let title = window.title.value || 'Garden'
    let story = []
    let works = []
    let sites = new Set()
    let metrics = {stories:selected.length,pages:0,words:0,length:0}
    window.result.innerHTML = ''

    story.push({type:'pagefold',text:'stories'})
    for (let want of selected) {
      try {
        let item = (await frame.context()).page.story.find(item => item.title == want)
        console.log(want,item)
        let site = item.site
        let page = await fetch(`//${site}/${frame.asSlug(item.title)}.json`).then(res => res.json())
        let words = page.metrics.words
        story.push({type:'paragraph', site, words, text:`[[${item.title}]] â€” ${item.text} (${words})`})

        works.push(page)
        window.result.innerHTML += ' .'
        metrics.pages += page.metrics.pages
        metrics.words += page.metrics.words

      } catch (err) {
        window.result.innerHTML += ' x'
        story.push({type:'code',text:`Trouble with ${want}\n${err.message}`})
      }
    }

    story.push({type:'pagefold',text:'garden'})
    story.push({type:'pagefold',text:'more'})

    for (let work of works) {
      let folds = folded(work.story, ['told','more'])
      let inlists = folds.more.filter(item => item.type != 'frame')
      story.push(...inlists)
      let rosters = inlists.filter(item => item.type == 'roster')
      rosters.forEach(roster =>
        roster.text.split('\n').forEach(site =>
          sites.add(site)))
      console.log({work,folds,inlists})
    }

    story.push({type:'frame',text:`http://ward.dojo.fed.wiki/assets/pages/story-telling/more-garden.html\nHEIGHT 200`})
    story.unshift({type:'paragraph', text:`Garden founded on
      ${metrics.stories} stories totaling
      ${metrics.pages} pages and
      ${metrics.words} words.
      ${metrics.links} unique links can expand into the garden.`})
    frame.open({title,story},event.shiftKey,[...sites])
  }

  function visit(page) {
    let links = []
    const link = /\[\[(.*?)\]\]/g
    let match
    for (let item of page.story) {
      if (item.type == 'reference') links.push(item.title)
      let text = item.text
      while (match = link.exec(text)) {
        links.push(match[1])
      }
    }
    return links
  }

</script>
