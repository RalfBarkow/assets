
<div id="result">waiting</div>
<p><button onclick=save()>download</button></p>
<style>
  table {
    font-family: Arial, Helvetica, sans-serif;
    border-collapse:collapse;
    width:100%;
  }
  tr,td {
    vertical-align:top;
    border:1px solid black;
    padding:4px;
  }

</style>
<script>


// P A R A M E T E R S

function hashed(hash, arg) {
    let op = arg.split(/=/)
    if (op[1]) hash[op[0]] = op[1]
    return hash
}

let query = window.location.href.split(/\?/)[1]||''
let params = query.split(/&/).reduce(hashed,{})

let minutes = params['minutes'] || 5
let fmt = params['fmt'] || 'column'


// L I S T E N

const socket = new WebSocket(`ws://${params['domain']||'localhost'}:4649/Spark`)

socket.addEventListener('open', (event) => {
  result.innerText = 'connected'
  socket.send('{"cmd":"subscribeToSpots","Enable":true}')
})

socket.addEventListener('message', (event) => {
    let msg = JSON.parse(event.data)
    tally(msg.spots)
})


// R E C O R D

let broadcast = {}  // call => spot         // merged with exchange
let exchange = {}   // call-call => [spots] // canonical keys
function tally(spots) {
  let m
  for (let spot of spots) {
    let msg = spot.msg
    let list = null
    if (m = msg.match(/^CQ (\w+ )?(\d?[A-Z]+\d[A-Z]+)\b/)) {
      let call = m[2]
      broadcast[call] = short(spot)
    } else if (m = msg.match(/^(\d?[A-Z]+\d[A-Z]+) (\d?[A-Z]+\d[A-Z]+)\b/)) {
      let called = m[1]
      let calls = [called, m[2]].sort().join(' - ')
      list  = exchange[calls] = exchange[calls] || cq(called)
      list.push(short(spot))
    }
  }
  activity()
}

function cq(call) {
  return broadcast[call] ? [broadcast[call]] : []
}

function short(spot) {
  delete spot.power
  delete spot.drift
  delete spot.mode
  delete spot.tunedfrequency
  delete spot.offsetFrequency
  delete spot.color
  delete spot.valid
  return spot
}


// R E N D E R

function activity() {
  let want = Date.now() - minutes*60000
  let all = Object.keys(exchange).map(prioritize).filter(each => each.time >= want)
  let old = Object.keys(broadcast).filter(call => new Date(broadcast[call].time).getTime() < want)
  for (let call of old) delete broadcast[call]
  if (fmt == 'column') {
    all.sort((a,b) => b.mins - a.mins)
    result.innerHTML = all.map(each => each.link).join('<br>')
  } else {
    all.sort((a,b) => a.time - b.time)
    result.innerHTML = table(all)
  }
}

function prioritize(calls) {
  let list = exchange[calls]
  let length = list.length
  let last = list[length-1]
  let first = list[0].msg.startsWith('CQ ') ? list[1] : list[0]
  let time = new Date(first.time).getTime()
  let mins = ((Date.now() - new Date(last.time).getTime())/60000).toFixed(1)
  let info = last.msg.split(' ').reverse()[0]
  let link = `<span onclick="link('${calls}')">${mins} ${calls} x${length} ${info} </span>`
  return {calls, time, mins, link}
}

function link(calls) {
  console.table(exchange[calls])
}

function table(all) {
  if (!all.length) return 'collecting'
  let last = 0
  let count = 1
  let rows = []
  let row = '<tr>'
  for (each of all) {
    let spots = exchange[each.calls]
    let length = spots.length
    if(each.time != last) {
      if(row != '<tr>') rows.push(row)
      rows.push(`<tr><td bgcolor="#eee">${new Date(each.time).toLocaleTimeString()}`)
      row = '<tr>'
      last = each.time
      count = 1
    } else if(count > 8) {
      rows.push(row)
      row = '<tr>'
      count = 1
    }
    let color = spots[length-1].msg.match(/73$/) ? 'black' : 'gray'
    row += `<td style="color:${color}">${spots.map(spot => spot.msg).join('<br>')}`
    count += 1
  }
  rows.push(row)
  return `<table>${rows.join("\n")}</table>`
}


// D O W N L O A D

function save() {
  download(JSON.stringify(exchange,null,2),'exchange.json')
}

function download(string, file) {
  var data = "data:text/json;charset=utf-8," + encodeURIComponent(string);
  var anchor = document.createElement('a');
  anchor.setAttribute("href",     data);
  anchor.setAttribute("download", file);
  document.body.appendChild(anchor); // required for firefox
  anchor.click();
  anchor.remove();
}
</script>