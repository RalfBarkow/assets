<div><center id=result></center></div>
<style>
  body {font-family: "Helvetica Neue", Verdana, helvetica, Arial, Sans;}
  div.box {padding:8px; margin-bottom:8px; background-color: #ddd;}
  img {width:115; height:86;}
  span {font-size:x-large; color:gray;}
</style>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  import * as index from 'http://code.fed.wiki/assets/v1/index.js'

  const uniq = (value, index, self) => self.indexOf(value) === index
  const delay = time => new Promise(res => setTimeout(res,time))

  const params = Object.fromEntries(new URLSearchParams(location.search).entries())
  const module = params['probe'] || `ImageCaptionSurvey`
  const title = module.replaceAll(/([a-z])([A-Z])/g,'$1 $2')
  const home = `http://code.fed.wiki/assets/pages/site-survey-factory`
  const probes = `${home}/probes`
  const {probe,format} = await import(`${probes}/${module}.js`)
  const neighbors = await frame.neighbors()
  const domain = neighbors[0]
  const site = await index.site(domain)
  const page = await site.page(title)
  const survey = page.story.find(item => item.survey).survey

  await index.update(site,survey,probe)
  const wants = survey.filter(info => info.title.endsWith(' Photos'))
  const photos = wants
    .map(info => info.images.map(image => {image.title = info.title; return image}))
    .flat()
  const tags = wants
    .map(info => info.images.map(image => image.text.trim().split(/ +/)))
    .flat(2).filter(uniq)
  const tuples = tags
    .map(tag => {
      const refs = []
      for(const info of wants) {
        for(const image of info.images) {
          if(image.text.trim().split(/ +/).includes(tag)) {
            image.title = info.title
            refs.push(image)
          }
        }
      }
      return {tag,refs}
    })
    .sort((a,b) => b.refs.length - a.refs.length)
  console.log({wants,photos,tags,tuples})

  const html = tuples => {
    const html = []
    for (const tuple of tuples) {
      const pix = tuple.refs.map(ref =>
        `<span onclick=dolink(event)><img width=100% data-title="${ref.title}" data-text="${ref.text}" src="http://${domain}${ref.url}"></span>`)
      html.push(`<div class=box ${pix.join(" ")}<br><span>${tuple.tag}</span></div><br>`)
    }
    return html.join("\n")
  }

  window.result.innerHTML = html(tuples.filter(tuple => tuple.refs.length>1))

  window.dolink = event => {
    const target = event.target
    const dataset = target.dataset
    const title = dataset.title
    if(!title) return
    const tags = dataset.text.trim().split(/ +/)
    if(params['drill']=='tags') {
      const title = tags.join(' ').replaceAll(/\b[a-z]/g, ch => ch.toUpperCase())
      const story = [
        {type:'html',text:html(tuples.filter(tuple => tags.includes(tuple.tag)))}
      ]
      frame.open({title, story},event.shiftKey)
    }
    else if (params['drill']=='joined') {
      const title = tags.join(' ').replaceAll(/\b[a-z]/g, ch => ch.toUpperCase())
      const url = target.getAttribute('src')
      const regexp = new RegExp(tags.map(tag=>`\\b${tag}\\b`).join('|'))
      const story = [
        {type:'paragraph',text:'This featured photograph shares at least one tag with each of the photos that follow.'},
        {type:'image',text:dataset.text,size:'wide',url},
        ...wants
          .map(info => {
            const list = info.images
              .filter(image => !url.endsWith(image.url))
              .filter(image => image.text.match(regexp))
              .map(image => ({type:'image',text:image.text,size:'thumbnail',url:image.url}))
            console.log({info,regexp,list})
            return [
              // {type:'pagefold',text:'week'},
              // {type:'paragraph',text:`[[${info.title}]]`},
              // {type:'pagefold',text:'.'},
              ...list
            ]})
          .flat()
      ]
      frame.open({title, story},event.shiftKey)
    }
    else {
      frame.link(title,event.shiftKey)      
    }
  }

</script>