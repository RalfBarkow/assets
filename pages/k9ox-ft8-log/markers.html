<html>
  <body style="font-family:sans-serif;">
    <pre id=log style="border-spacing:8px;"></pre>
    <script>

      Promise.all([get('callbook.txt'), get('wsjtx_log.adi')])
        .then(f => log.innerHTML = markers(f[1], callbook(f[0])))

      function get(file) {
        return fetch(`http://found.ward.bay.wiki.org/assets/pages/k9ox-ft8-log/${file}`)
          .then(res=>res.text())
          .then(text=>text.trim().split(/\r?\n/))
      }

      function callbook(calls) {
        let latlon = {}
        for (let line of calls) {
          let [call, grid] = line.split(/\t/)
          latlon[call] = maidenhead(grid.toUpperCase())
        }
        return latlon
      }

      function markers(lines, latlon) {
        let report = []
        for (let line of lines) {
          if (!line.match(/^</)) continue
          let row = fields(line)
          let geo = latlon[row.call] || maidenhead(row.gridsquare)
          report.push(`${geo[0]}, ${geo[1]} ${row.call}`)
        }
        return report.join("\n")
      }

      function fields(line) {
        const field = /<(\w+):\d+>([^<]*)/g
        let row = {}
        while (m = field.exec(line)) {
          row[m[1]] = m[2].trim()
        }
        return row
      }

      function maidenhead(grid) {
        // https://en.wikipedia.org/wiki/Maidenhead_Locator_System
        const a = i => grid.charCodeAt(i)-'A'.charCodeAt(0) || 0
        const n = i => grid.charCodeAt(i)-'0'.charCodeAt(0) || 0
        let lat = a(1)*10 + n(3)*1 + a(5)/24 + n(7)/240 - 90
        let lon = a(0)*20 + n(2)*2 + a(4)/12 + n(6)/120 - 180
        return [1*lat.toFixed(5),1*lon.toFixed(5)]
      }

    </script>
  </body>
</html>      