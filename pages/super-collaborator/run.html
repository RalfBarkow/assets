<html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚗️</text></svg>">
  <script src="https://unpkg.com/@hpcc-js/wasm/dist/index.min.js"></script>
  <script> var hpccWasm = window["@hpcc-js/wasm"]; </script>
</head>
<body>

<style>
  html, body, main { width: 100vw; height: 100vh; margin: 0;}
  main {
    display: grid;
    grid-template-areas:
      "beam   target"
      "create target"
      "chat   target";
    grid-template-columns: 1fr 3fr;
    grid-template-rows: 2fr 4fr 1fr;
  }
  #beam   {grid-area:beam; background-color:palegreen;}
  #create {grid-area:create; background-color:bisque;}
  #target {grid-area:target; overflow:scroll;}
  #chat   {grid-area:chat; background-color:lightblue;}
  #beam, #create, #chat {
    margin:4px;
    padding:8px;
    overflow-y: scroll;
 }
</style>

<main>
  <div id="beam" onclick="dochoose(event)"></div>
  <div id="target" ondrop="drop(event)" ondragover="over(event)" ondragenter="over(event)"></div>
  <div id="create"></div>
  <div id="chat">
    <div id="textOut"></div>
    <input id="textIn" type="text" onkeydown="event.keyCode == 13 && sendButton.onclick()"/>
    <input id="sendButton" type="button" value = "Send" />
  </div>
</main>

<script src="https://unpkg.com/@croquet/croquet"></script>
<script type=module>

  import {Graph} from 'https://wardcunningham.github.io/graph/graph.js'
  import {drop} from './drop.js'
  import {composite} from './composite.js'
  import {dotify} from './dotify.js'
  import {create} from './create.js'

  const croquet = {model:null, view:null}

  const created = {name:'empty', graph:new Graph()}
  create(window.create, graph => {
    // Object.assign(created, {name:graph.nodes[0]?.props?.name||'void', graph});
    // refresh()
  })

  window.over = function (event) {
    event.preventDefault()
  }

  window.drop = async function (event) {
    event.preventDefault();
    const poems = await drop(event)
    croquet.view.send(`drop ${poems.map(poem => poem.name).join(', ')}`)
    croquet.view.newPoems(poems)
    // display(poems)
  }

  window.dochoose = refresh

  function refresh() {
    const checked = [...window.beam.querySelectorAll('input[type=checkbox]:checked')]
    const beam = croquet.view.beam()
    const chosen = checked.map(e => beam[e.value])
    display([...chosen,created])
  }

  let drawing = false
  function display(chosen) {
    if(!drawing){
      drawing = true
      const complex = composite(chosen)
      hpccWasm.graphviz.layout(dotify(complex), "svg", "dot").then(svg => {
        target.innerHTML = svg;
        drawing = false
      })
    } else {
      console.log('display: skipping', chosen)
    }
  }


  class BeamModel extends Croquet.Model {

    init() {
      this.views = new Map();
      this.participants = 0;
      this.history = []; // { viewId, html } items
      this.beam = []; //{name, graph}
      this.lastPostTime = null;
      this.inactivity_timeout_ms = 60 * 1000 * 20; // constant
      this.subscribe(this.sessionId, "view-join", this.viewJoin);
      this.subscribe(this.sessionId, "view-exit", this.viewExit);
      this.subscribe("input", "newPost", this.newPost);
      this.subscribe("input", "reset", this.resetHistory);
      this.subscribe("input", "newPoems", this.newPoems);
      croquet.model = this
    }

    static types() {
      return {
        "Graph": Graph
      };
    }

    viewJoin(viewId) {
      const existing = this.views.get(viewId);
      if (!existing) {
        const nickname = this.randomName();
        this.views.set(viewId, nickname);
      }
      this.participants++;
      this.publish("viewInfo", "refresh");
    }

    viewExit(viewId) {
      this.participants--;
      this.views.delete(viewId);
      this.publish("viewInfo", "refresh");
    }

    newPost(post) {
      const postingView = post.viewId;
      const nick = this.views.get(postingView);
      const chat = this.escape(post.chat);
      this.addToHistory({ viewId: postingView, nick, chat });
      this.lastPostTime = this.now();
      this.future(this.inactivity_timeout_ms).resetIfInactive();
    }

    newPoems(poems) {
      this.addToBeam(poems)
    }

    addToHistory(item){
      this.history.push(item);
      if (this.history.length > 100) this.history.shift();
      this.publish("history", "refresh");
    }

    addToBeam(poems) {
      this.beam.push(...poems)
      this.publish("beam", "refresh")
    }

    resetIfInactive() {
      if (this.lastPostTime !== this.now() - this.inactivity_timeout_ms) return;
      this.resetHistory("due to inactivity");
    }

    resetHistory(reason) {
      this.history = [{ nick:'system', chat: `reset ${reason}` }];
      if (reason == "at user request") this.beam = []
      this.lastPostTime = null;
      this.publish("history", "refresh");
      this.publish("beam", "refresh")
    }

    escape(text) { // Clean up text to remove html formatting characters
      return text.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;");
    }

    randomName() {
      return (Math.random()*1000000).toFixed(0)
    }

  }

  BeamModel.register("BeamModel");

  class BeamView extends Croquet.View {

    constructor(model) {
      super(model);
      this.model = model;
      sendButton.onclick = () => {this.send(textIn.value); textIn.value = "";};
      this.subscribe("history", "refresh", this.refreshHistory);
      this.subscribe("viewInfo", "refresh", this.refreshViewInfo);
      this.subscribe("beam", "refresh", this.refreshBeam);
      this.refreshHistory();
      this.refreshViewInfo();
      this.refreshBeam()

      if (model.participants === 1 &&
        !model.history.find(item => item.viewId === this.viewId)) {
        this.publish("input", "reset", "for new user");
      }
      croquet.view = this
    }

    send(text) {
      if (text === "/reset") {
        this.publish("input", "reset", "at user request");
      } else {
        this.publish("input", "newPost", {viewId: this.viewId, nick:'system', chat:text});
      }
    }

    newPoems(poems) {
      this.publish("input", "newPoems", poems)
    }

    refreshViewInfo() {
      console.log('users', this.model.participants)
    }

    refreshHistory() {
      textOut.innerHTML = this.model.history
        .map(item => `${item.nick}: ${item.chat}`).join("<br>");
      sendButton.scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"})
    }

    refreshBeam() {
      const want = [...window.beam.querySelectorAll('input[type=checkbox]:checked')]
        .map(e => +e.value)
      const names = this.model.beam.map(poem => poem.name)
      window.beam.innerHTML = names.map((n,i) =>
          `<input type=checkbox value=${i} ${want.includes(i)?'checked':''}>${n}`)
        .join("<br>")
      window.beam.querySelector('input:last-of-type')
        .scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"})
    }

    beam() {
      return this.model.beam
    }
  }

  Croquet.Session.join({
    apiKey: '1MNinyGopbyxFzgx3HupBoCAryFb6yNOIihx6Omx9',
    appId: 'com.gmail.ward.cunningham.collaborator',
    name: "unnamed",
    password: "secret",
    model: BeamModel,
    view: BeamView
  })


</script>
</body>
</html>
