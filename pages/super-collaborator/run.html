<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚗️</text></svg>">
  <script src="https://unpkg.com/@hpcc-js/wasm/dist/index.min.js"></script>
  <script> var hpccWasm = window["@hpcc-js/wasm"]; </script>
</head>

<table>
  <tr style="height:50%">
    <td style="width:25%">
      <div id=beam onclick=dochoose(event)>Work in Progress
    <td style="width:75%" rowspan=2>
      <div id=target ondrop="drop(event)" ondragover="over(event)" ondragenter="over(event)">System for Action
  <tr>
    <td>
      <div id=create>
</table>

<style>
  table {height:100%; width:100%; border-collapse:collapse;}
  td, th {border:1px solid gray; padding:8px;}
  div {height: 100%; background-color:white;}
</style>

<script type=module>

  import {Graph} from 'https://wardcunningham.github.io/graph/graph.js'
  import {drop} from './drop.js'
  import {composite} from './composite.js'
  import {dotify} from './dotify.js'
  import {create} from './create.js'

  const names = ['beauty','diagram','gamma','instantiation','life','modeler','morning','thing']
  const graphs = await Promise.all(names
    .map(n => Graph.fetch(`http://ward.dojo.fed.wiki/assets/pages/daily-haiku-graph/${n}.graph.json`)))
  window.beam.innerHTML = `${names.map((n,i) => `<input type=checkbox value=${i}>${n}`).join("<br>")}`
  const created = {name:'empty', graph:new Graph()}
  create(window.create, graph => {
    Object.assign(created, {name:graph.nodes[0]?.props?.name||'void', graph});
    refresh()
  })

  window.over = function (event) {
    event.preventDefault()
  }

  window.drop = async function (event) {
    event.preventDefault();
    const concepts = await drop(event)
    display(concepts)
  }

  window.dochoose = refresh

  function refresh() {
    const checked = [...window.beam.querySelectorAll('input[type=checkbox]:checked')]
    const chosen = checked.map(e => ({name:names[e.value], graph:graphs[e.value]}))
    display([...chosen,created])
  }

  function display(chosen) {
    const complex = composite(chosen)
    hpccWasm.graphviz.layout(dotify(complex), "svg", "dot").then(svg => {
      target.innerHTML = svg;
    })    
  }

</script>
