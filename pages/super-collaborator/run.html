<html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚗️</text></svg>">
  <script src="https://unpkg.com/@hpcc-js/wasm/dist/index.min.js"></script>
  <script> var hpccWasm = window["@hpcc-js/wasm"]; </script>
</head>
<body>

<style>
  html, body, main { width: 100vw; height: 100vh; margin: 0;}
  main {
    display: grid;
    grid-template-areas:
      "beam   target"
      "create target"
      "chat   target";
    grid-template-columns: 1fr 3fr;
    grid-template-rows: 2fr 4fr 1fr;
  }
  #beam   {grid-area:beam; background-color:palegreen;}
  #create {grid-area:create; background-color:bisque;}
  #target {grid-area:target; overflow:scroll;}
  #chat   {grid-area:chat; background-color:lightblue;}
  #beam, #create, #chat {
    margin:4px;
    padding:8px;
    overflow-y: scroll;
 }
</style>

<main>
  <div id="beam" onclick="dochoose(event)"></div>
  <div id="target" ondrop="drop(event)" ondragover="over(event)" ondragenter="over(event)"></div>
  <div id="create"></div>
  <div id="chat">
    <div id="textOut"></div>
    <input id="textIn" type="text" onkeydown="event.keyCode == 13 && sendButton.onclick()"/>
    <input id="sendButton" type="button" value = "Send" />
  </div>
</main>

<script src="https://unpkg.com/@croquet/croquet"></script>
<script type=module>

  import {Graph} from 'https://wardcunningham.github.io/graph/graph.js'
  import {drop} from './drop.js'
  import {composite} from './composite.js'
  import {dotify} from './dotify.js'
  import {create} from './create.js'
  import {BeamModel, BeamView, croquet} from './beam.js'

  const creating = {
    index: -1,
    start: (graph) => {
      creating.index = croquet.view.beam().length
      croquet.view.newPoems([{name:'⋯',graph}])
    },
    update: (graph) => {
      croquet.view.updatePoem(creating.index, graph, '⋯')
    },
    finish: (graph) => {
      croquet.view.updatePoem(creating.index, graph, '')
      creating.index = -1
    }
  }
  create(window.create, creating)

  window.over = function (event) {
    event.preventDefault()
  }

  window.drop = async function (event) {
    event.preventDefault();
    const poems = await drop(event)
    croquet.view.send(`drop ${poems.map(poem => poem.name).join(', ')}`)
    croquet.view.newPoems(poems)
  }

  window.dochoose = function (event) {
    const checked = [...window.beam.querySelectorAll('input[type=checkbox]:checked')]
    const beam = croquet.view.beam()
    const chosen = checked.map(e => beam[e.value])
    display([...chosen])
  }

  let drawing = false
  function display(chosen) {
    if(!drawing){
      drawing = true
      const complex = composite(chosen)
      hpccWasm.graphviz.layout(dotify(complex), "svg", "dot").then(svg => {
        target.innerHTML = svg;
        drawing = false
      })
    } else {
      console.log('display: skipping', chosen)
    }
  }


  Croquet.Session.join({
    apiKey: '1MNinyGopbyxFzgx3HupBoCAryFb6yNOIihx6Omx9',
    appId: 'com.gmail.ward.cunningham.collaborator',
    name: "unnamed",
    password: "secret",
    model: BeamModel,
    view: BeamView
  })


</script>
</body>
</html>
