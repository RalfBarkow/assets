<html>
  <head>
      <script src="https://unpkg.com/@croquet/croquet@1.0"></script>
      <script type=module>

       window.addEventListener("message", collectCodeFromContext, {once: true})
       window.parent.postMessage({ action:"sendFrameContext" }, "*")

       function collectCodeFromContext ({data}) {
           if (data.action == "frameContext") {
               const {slug, item, page} = data
               let code = page.story.filter(it => it.type == 'code').map(it => it.text)
               if (code.length) { render(code.join("\n")) }
           }
       }

       async function render (text) {
           console.log({text})
           try {
               let module = await import(`data:text/javascript;base64,${btoa(text)}`)
               if (!module) return
               let emit = module.emit
               if (emit) {
                   await emit(document.body)
               }
               let bind = module.bind
               if (bind) {
                   await bind(document.body)
               }
           } catch (e) {
               const {name, message} = e
               document.body.innerHTML = `<pre>${JSON.stringify({name, message}, null, 2)}</pre>`
           }
       }

      </script>

  </head>
  <body>

    <h1 id="diceRoll">0</h1>
    <button id="rollButton">Roll</button>
  </body>
</html>
