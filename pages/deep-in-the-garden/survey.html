<p>
  <button onclick=dosurvey(event)>scan</button>
  <button onclick=doprint(event)>download</button>
</p>
<div id=report></div>
<style>
  body { font-family: verdana, helvetica, sans; font-size: smaller; }
  td { border: 1px solid gray; padding: 4px; text-align:center;  }
  table { border-collapse: collapse; }
</style>

<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  import {Graph} from 'https://wardcunningham.github.io/graph/graph.js'
  const uniq = (value, index, self) => self.indexOf(value) === index
  const tick = value => {window.report.innerText += ' .'; return value}

  const cols = []
  let maps = null
  let graphs = null

  const page = (await frame.context()).page
  const sites = page.story
    .filter(item => item.type=='reference')
    .map(item => item.site)
  const assets = (await frame.assets())
    .filter(asset => asset.dir == "pages/deep-in-the-garden/graphs")
  window.report.innerText = 'ready'

  // console.log({sites,maps,assets,graphs})
  // window.report.innerHTML = `<pre>
  //   ${sites.length} stories, ${maps.map(infos => infos.length)} pages
  //   ${graphs.length} graphs, ${graphs.map(graph => graph.nodes.length)} nodes`

  window.dosurvey = async event => {
    window.report.innerText = ''
    maps = await Promise.all(
      sites.map(site => fetch(`//${site}/system/sitemap.json`)
        .then(res => tick(res.json()))))
    graphs = await Promise.all(
      assets.map(asset => fetch(asset.url)
        .then(res => tick(res.text()))
        .then(text => JSON.parse(text))
        .then(json => new Graph(json.nodes, json.rels))
      ))
    sites.forEach((site,i) => {
      const map = maps[i]
      const garden = [
        graphs[i].nodes
        .filter(node => node.type=='Story')
        .map(node => frame.asSlug(node.props.name))]
      cols.push({site,map,garden})
    })
    for (let depth=1; depth<=8; depth++) {
      cols.forEach(col => {
        const have = col.garden.flat()
        const doing = col.garden.slice(-1)[0]
        const want = doing.map(slug => {
          const info = col.map.find(info => info.slug == slug)
          if(info?.links) {
            return Object.keys(info.links)
          }
          else
            return []
        }).flat()
          .filter(slug => !have.includes(slug))
          .filter(uniq)
        col.garden.push(want)
      })
      console.log(depth,cols.map(col => col.garden[col.garden.length-1].length))
    }
    window.report.innerHTML = `
      <table>
      ${[0,1,2,3,4,5,6,7,8].map(row => 
        `<tr><td>${row}${[0,1,2].map(col =>
          `<td>${cols[col].garden[row].length}`).join('')}`).join('')}
      </table>
    `
  }

  window.doprint = event => {
    const format = (row,col) => {
      const slugs = cols[col].garden[row]
      const titles = slugs.map(slug => cols[col].map.find(info => info.slug == slug)?.title||slug)
      return titles.join('<br>')
    }
    const html = `
      <style>
        body { font-family: verdana, helvetica, sans; font-size: smaller; }
        td { border: 1px solid gray; padding: 4px; text-align:left; vertical-align:top; }
        table { border-collapse: collapse; }
      </style>
      <table>
      ${[0,1,2,3,4,5,6,7,8].map(row => 
        `<tr><td colspan=3>${row}
         <tr>${[0,1,2].map(col =>
          `<td>${format(row,col)}`).join('')}`).join('')}
      </table>
    `
    frame.download(html,'DeepGarden.html','text/html')
  }

</script>
