<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŸ¨</text></svg>">

<section style="display:flex">
  <!-- <div id=metadata style="flex:20%; padding:16px;"></div> -->
  <div id=basemap style="flex:100%"></div>
</section>

<script type=module>

  const params = Object.fromEntries(new URLSearchParams(location.search).entries())

  const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms))


// L O A D   D A T A

  let cases = []
  let basemap = ''
  let site = `http://code.fed.wiki`
  let assets = `${site}/assets/pages/working-within-the-lineup`

  let loading = Promise.all([
    fetch(`${site}/use-case-survey.json`).then(req => req.json()).then(page => parse(page)),
    fetch(`${assets}/${params['svg']||'working-within-the-lineup'}.svg`).then(req => req.text()).then(text => {basemap = text})
  ])
  await loading

  function parse(page) {
    for (let item of page.story) {
      if(item.type == 'markdown') {
        if (item.text.startsWith('#')) {
          let use = item.text.split(/ *[#\[] */)[1]
          console.log({use})
        }
        else {
          for (let line of item.text.split(/\n/)) {
            cases.push(line.replace(/^- */,'').split(/ *â‡’ */))
          }          
        }
      }
    }
    console.log({cases})
  }

  basemap = basemap
    .replace(/<svg width=".*?" height=".*?"/,"<svg ")
    .replace(/<\/g>\n<\/svg>/,"<g id=\"animation\"></g>\n</g>\n</svg>")
  window.basemap.innerHTML = basemap

  let places = {}
  let nodes = window.basemap.getElementsByClassName('node')
  for (let node of [...nodes]) {
    let title = [...node.getElementsByTagName('text')].map(text => text.innerHTML).join(' ')
    let text = node.getElementsByTagName('text').item(0)
    let x = text.getAttribute('x')
    let y = text.getAttribute('y')
    places[asSlug(title)] = {x,y}
  }
  console.log(places)


// P L A Y   A N I M A T I O N

  while (true) {
    for (let usecase of cases) {
      await display(route(usecase))
      await delay(500)
      window.animation.innerHTML = ''
      await delay(200)

    }
    window.animation.innerHTML = ''
    await delay(3000)
  }

  function route(usecase) {
    let moves = []
    for (let i = 0; i+1 < usecase.length; i++) {
      moves.push([asSlug(usecase[i]), asSlug(usecase[i+1])])
    }
    return moves
  } 

  async function display (moves) {
    let f = places[moves[0][0]]
    window.animation.innerHTML = `<circle cx="${f.x}" cy="${f.y}" r="8" stroke="red" fill="red"/>`
    await delay(400)

    let squiggle = []
    for (let move of moves) {
      let a = places[move[0]]
      let b = places[move[1]]
      squiggle.push(`<circle cx="${a.x}" cy="${a.y}" r="8" stroke="red" fill="red"/>`)
      squiggle.push(`<circle cx="${b.x}" cy="${b.y}" r="8" stroke="red" fill="red"/>`)
      squiggle.push(`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="red" stroke-width="8" stroke-opacity=".4" />`)
      window.animation.innerHTML = squiggle.join("\n")
      await delay(200)
    }
  }

</script>