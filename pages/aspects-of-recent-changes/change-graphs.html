<div id=result>working</div>
<script type=module>
  import * as frame from 'http://code.fed.wiki/assets/v1/frame.js'
  import {Graph} from 'https://wardcunningham.github.io/graph/graph.js'

  const context = await frame.context()
  const neighbors = await frame.neighbors()
  const more = Symbol('more')
  const sitemaps = await Promise.all(neighbors
    .map(site => fetch(`//${site}/system/sitemap.json`)
      .then(res => res.json())
      .then(info => {info[more]={site}; return info})))
  const allmaps = sitemaps.flat()
  window.result.innerHTML = sitemaps
    .map(sitemap => `${sitemap[more].site} ${sitemap.length} pages`)
    .join("<br>")
  const now = Date.now()
  const intervals = {
    day: 24*60*60*1000,
    week: 24*60*60*1000*7,
    month: 24*60*60*1000*30}
  const interval = intervals.week
  console.log({neighbors,sitemaps,now,interval})

  const aspects = [emphasis(),colors()]
  for (let i = 0; i<52; i++) {
    const last = now-interval*i
    const name = new Date(last).toLocaleDateString()
    const nodes = edited(last-interval, last)
    if (nodes.length) {
      const graph = linked(nodes)
      // aspects.push({name,graph})
      aspects.push(...partitions({name,graph}))
    }
  }

  function emphasis() {
    const name = 'Page Colors'
    return {name, graph:new Graph ([{
      type:'Graphviz',
      in:[], out:[],
      props:{name,
        emphasis:{
          Page:"fillcolor=lightblue",
          Prompt:"fillcolor=bisque",
          Graphviz:"fillcolor=white"
        }
      }}],[])
    }
  }

  function colors() {
    const name = 'Page Colors'
    return {name, graph:new Graph ([{
      type:'Graphviz',
      in:[], out:[],
      props:{name,
        colors:{
          Page:"lightblue",
          Prompt:"bisque"
        }
      }}],[])
    }
  }

  window.dodownload = function(event) {
    const text = aspects
      .map(aspect => JSON.stringify(aspect))
      .join("\n")
    const name = `${context.slug}.jsonl`
    frame.download(text,name,'application/json')
  }

  window.result.innerHTML += `
    <p><button onclick=dodownload(event)>download</button></p>`

  function edited(first,last) {
    return sitemaps
      .map(sitemap => sitemap
        .filter(info => info.date > first && info.date <= last)
        .filter(info => info.links))
      .flat()
  }

  function linked(infos) {
    const graph = new Graph()
    const node = slug => {
      const type = slug.includes('-and-') ? 'Prompt' : 'Page'
      const title = allmaps.find(info => info.slug==slug).title
      const name = title.replaceAll(' ',"\n")
      const nid = graph.nodes.findIndex(node => node.type==type && node.props.name==name)
      return (nid>=0) ? nid : graph.addNode(type,{name})
    }
    for (const info of infos) {
      const nid = node(info.slug)
      for (const name of newest(Object.keys(info.links))) {
        graph.addRel('',nid,node(name))
      }
    }
    return graph
  }

  function newest(slugs) {
    const recent = slug => allmaps
      .filter(info => info.slug == slug)
    return slugs
      .map(slug => [slug,recent(slug)])
      .filter(pair => pair[1].length)
      .map(pair => [pair[0],pair[1].sort((a,b) => b.date - a.date)[0]])
      .sort((a,b) => b[1].date - a[1].date)
      .map(pair => pair[0])
      .slice(0,3)
  }

  function partitions(aspect) {
    const input = aspect.graph
    const output = [] // graphs
    let doing = {} // nid => new nid
    // const checkpoint = () => {
    //   window.progress.innerText = output
    //     .map(graph => `${print(graph.nodes)}\n\n${print(graph.rels)}`)
    //     .join("\n\n")
    // }
    const nodes = input.nodes
    const rels = input.rels
    const todo = [...Array(nodes.length).keys()]
      .map(n => [n,Math.random()])
      .sort((a,b)=>a[1]-b[1])
      .map(v=>v[0])

    const copy = nid => {
      if(nid in doing) {
        // console.log('copied before', nid, 'doing', doing)
        return}
      // console.log('copy start', nid, 'doing', doing)
      todo.splice(todo.indexOf(nid),1)
      const node = nodes[nid]
      doing[nid] = output[0].addNode(node.type,node.props)
      for (const rid of node.out) copy(rels[rid].to)
      for (const rid of node.in) copy(rels[rid].from)
      // console.log('linking',nid,'to',node.out.map(rid => rels[rid].to))
      for (const rid of node.out) output[0].addRel('',doing[nid],doing[rels[rid].to],{})
      // checkpoint()
    }

    // console.log('order todo',todo)
    while(todo.length) {
      const nid = todo.shift()
    // for (let nid of todo) {
      if (nid in doing) {
        // console.log('did',nid,'already')
        continue
      }
      const node = nodes[nid]
      const title = node.props.name.replaceAll("\n"," ")
      if (node.in.length + node.out.length) {
        // console.log('doing',nid,title)
        output.unshift(new Graph())
        doing = {}
        copy(nid)     
      }
      // else
        // console.log('skipping',nid,title)
    }
    return output.reverse()
      .map((graph,i) => ({name:`${aspect.name}.${i}`,graph}))
  }

</script>