<div id=report></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script type=module>

const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()

let assets = await sources('assets')
report('sources',{assets})

let panel = assets[0].panel
report('panel',panel)

let assetData = assets[0].assetsData
let folder = Object.keys(assetData)[0]
let files = assetData[folder]['/assets']
report('assets',{folder,files})

let context = await frameContext()
report('context',context)

let url = `//${context.site}/assets/${folder}/${files[0]}`
report('url',{url})

let data = await csv(url)
let columns = data.columns
report('csv',{columns,data})

let survey = {}
for (let row of data) {
  let who = row[columns[1]]
  survey[who] = {}
  for (let col of columns.slice(2)) {
    let key = col.split('>')[0]
    survey[who][key] = row[col]
  }
}
report('survey',survey)

window.report.innerHTML += `<p><button onclick=doimport(event)>import</button></p>`

window.doimport = function (event) {
  let inquiry = files[0].split(' ')[0]
  let pages = {}
  let index = []
  for (let who in survey) {
    let title = `${who}: ${inquiry}`
    let story = [{type:'paragraph', text:'Reported degree of agreement. 1 star is low agreement and 5 stars is a high agreement.'}]
    for (let col of columns.slice(2)) {
      let [key, description] = col.split(/ *> */)
      story.push({type:'paragraph',text:`[[${key}]]`})
      story.push({type:'fivestar',text:key,key,stars:`${survey[who][key]}`})
      story.push({type:'paragraph',text:description})
    }
    pages[asSlug(title)] = {title, story}
    index.push(`- [[${title}]]\n`)
  }
  let title = `${inquiry} Index`
  let story = [
    {type:'paragraph',text:'Pages imported with [[Survey Decoder]].'},
    {type:'markdown',text:index.join("")}
  ]
  pages[asSlug(title)] = {title, story}
  let message = {
    action: "importer",
    pages,
    keepLineup: event.shiftKey
  }
  window.parent.postMessage(message, "*");
}

function report(label, data) {
  window.report.innerHTML += `
    <details>
      <summary>${label} â€” ${Object.keys(data).join(", ")}</summary>
      <pre>${JSON.stringify(data,null,2)}</pre>
    </details>\n`
}

function csv(url) {
  return new Promise(resolve => window.d3.csv(url,resolve))
}


// U T I L I T I E S

function frameContext() {
  return new Promise(resolve => {
    let handler = event => {
      let {data} = event
      if (!data.action == "frameContext") return
      window.removeEventListener('message',handler)
      resolve(data)
    }
    window.addEventListener('message',handler)
    window.parent.postMessage({action:"sendFrameContext"},"*")
  })
}

// function open(page, keepLineup=false, forks=[]) {
//   const dup = obj => JSON.parse(JSON.stringify(obj))
//   let date = Date.now()
//   for (let item of page.story) item.id = (Math.random()*10**20).toFixed(0)
//   page.journal = [{type:'create', date, item:dup(page)}, ...forks.map(site => ({type:'fork',date,site}))]
//   let message = {action: "showResult", page, keepLineup}
//   window.parent.postMessage(message, "*");
// }

// function download(string, file) {
//   var data = "data:text/json;charset=utf-8," + encodeURIComponent(string);
//   var anchor = document.createElement('a');
//   anchor.setAttribute("href",     data);
//   anchor.setAttribute("download", file);
//   document.body.appendChild(anchor); // required for firefox
//   anchor.click();
//   anchor.remove();
// }

function sources(topic) {
  const action = 'requestSourceData'
  return new Promise(resolve => {
    let handler = event => {
      let {data} = event
      if (!data.action == action) return
      window.removeEventListener('message',handler)
      resolve(data.sources)
    }
    window.addEventListener('message',handler)
    window.parent.postMessage({action, topic},"*")
  })
}


</script>