<section style="display:flex">
  <div id=metadata style="flex:30%; padding:16px;"></div>
  <div id=basemap style="flex:70%"></div>
</section>

<script type=module>

  const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms))

  let history = []
  let basemap = ''

  let site = `http://trails.ward.asia.wiki.org`
  let assets = `${site}/assets/pages/edit-history`

  let loading = Promise.all([
    fetch(`${assets}/history.json`).then(req => req.json()).then(json => {history = json}),
    fetch(`${assets}/basemap.svg`).then(req => req.text()).then(text => {basemap = text})
  ])
  await loading
  basemap = basemap
    .replace(/<svg width=".*?" height=".*?"/,"<svg ")
    .replace(/<\/g>\n<\/svg>/,"<g id=\"annimation\"></g>\n</g>\n</svg>")
  window.basemap.innerHTML = basemap

  let places = {}
  let nodes = window.basemap.getElementsByClassName('node')
  for (let node of [...nodes]) {
    let title = node.getElementsByTagName('title').item(0).innerHTML.replace(/\n/g,' ')
    let text = node.getElementsByTagName('text').item(0)
    let x = text.getAttribute('x')
    let y = text.getAttribute('y')
    places[asSlug(title)] = {x,y}
  }
  console.log(places)

  let start = 1600855200000
  let last = Date.now()
  while (start < last) {
    let finish = start + (24*60*60*1000)
    let today = history.filter(act => act.date >= start && act.date < finish && places[act.slug])
    if (today.length) {
      let moves = []
      let slug = today[0].slug
      for (let moment of today) {
        if (moment.slug != slug) {
          if (!moves.find(m => (m[0]==slug && m[1]==moment.slug) || m[1]==slug && m[0]==moment.slug)) {
            moves.push([slug, moment.slug])
          }
          slug = moment.slug
        }
      }
      if (moves.length) {
        window.metadata.innerHTML = `<h3>${new Date(start).toLocaleDateString()}</h3>${moves.join("<br>")}`
        let squiggle = []
        for (let move of moves) {
          let a = places[move[0]]
          let b = places[move[1]]
          squiggle.push(`<circle cx="${a.x}" cy="${a.y}" r="5" stroke="red" fill="red"/>`)
          squiggle.push(`<circle cx="${b.x}" cy="${b.y}" r="5" stroke="red" fill="red"/>`)
          squiggle.push(`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="red" stroke-width="5" stroke-opacity=".4" />`)
        }
        window.annimation.innerHTML = squiggle.join("\n")
        await delay(200)
      }
    }
    start = finish
  }

</script>