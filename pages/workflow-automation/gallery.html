<div id=gallery></div>

<style>
  body {
    background-color: lightgray;
    font-family: Verdana, helvetica, Arial, Sans;
  }
  a {
    text-decoration: none;
  }
</style>

<script type=module>

  const site = 'http://trails.ward.asia.wiki.org'
  const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()

  let year = 2020
  let months = `january,february,march,april,may,june,july,august,september,october,november,december`.split(',')

  let slug = location.search || 'chronological-destinations'
  let segments = {} // label => [trail]

  let [index,images] = await Promise.all([
    fetch(`${site}/${slug.replace('?','')}.json`).then(res => res.json()),
    fetch(`${site}/assets/pages/chronological-wandering/images.json`).then(res => res.json())
  ])

  // {
  //   "spring-2021": {
  //     "SW Lowell Court": [
  //       "IMG_5010.jpg",
  //       "IMG_5077.jpg",
  //       "IMG_5079.jpg"
  //     ], ...
  //   }, ...
  // }

  let segment = []
  for (let item of index.story) {
    if (item.type == 'pagefold') {
      segment = segments[fold(item)] = []
    }
    else if (item.type == 'paragraph') {
      let m = item.text.match(/^\[\[(.+?)\]\](.*)$/)
      if (m) {
        segment.push(m[1])
      }
    }
  }

  for (let fold in segments) {
    let html = [`<h2>${fold}</h2><table>`]
    for (let trail of segments[fold]) {
      let slug = asSlug(trail)
      html.push(`<tr><td colspan=2><a href=${site}/${slug}.html target=_blank>${trail}</a>`)
      html.push(`<tr>`)
      for (let season in images) {
        if (images[season][trail]) {
          for (let image of images[season][trail]) {
            html.push(`<td>
              <div style="width:320px; margin:8px;">
                <img width=320 height=240 src=${site}/assets/pages/${season}/${image}>
              </div>`)
          }
        }
      }
    }
    html.push(`</table>`)
    window.gallery.innerHTML += html.join("\n")
  }

  function fold (item) {
    let text = item.text
    let month = months.find(name => name.startsWith(text))
    if (month) {
      if (month == 'january') year++
      text = `${month.charAt(0).toUpperCase() + month.slice(1)} ${year}`
    }
    return text
  }

</script>