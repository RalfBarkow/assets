<center>
<p><input id=root type=text>
<button onclick=doexp(event)>exp</button>
<button onclick=dosum(event)>sum</button>
<button onclick=dosum(event)>mul</button>
</p>
<pre id=result>ready</pre>
</center>

<script type=module>
  window.doexp = event => {
    const root = +window.root.value
    let expr = `${root**5}^(1/5)\n`; window.result.innerText = expr
    expr = expr.replace(/\(1\/5\)/, `(1/${5**4}^(1/4))`); window.result.innerText += expr
    expr = expr.replace(/\(1\/4\)/, `(1/${4**3}^(1/3))`); window.result.innerText += expr
  }

  window.dosum = async event => {
    window.result.innerText='running'
    await new Promise(res => setTimeout(res,100))
    const type = event.target.innerText
    const root = +window.root.value
    const digits = ([1,2,3,4,5,6,7,8,9])
      .map(digit => [digit,Math.random()])
      .sort((a,b) => a[1]-b[1])
      .map(tuple => tuple[0])
    let tries = 0
    let hits = []
    search(digits,[],[])
    window.result.innerText = hits.length ? hits.join("\n") : `try again`

    function search(digits,stack,rpn) {
      // console.log(`${rpn} => ${stack}`)
      if(tries++ > 1000000 || hits.length > 17) return hits
      if(stack.length==1 && stack[0]==root) {
        const expr = infix(rpn)
        if(!hits.includes(expr)) hits.push(expr)
      }
      if(stack.length>=2) {
        const [a,b,...rest] = stack
        if (type=='sum') {
          search (digits,[a+b,...rest],[...rpn,'+'])
          search (digits,[a-b,...rest],[...rpn,'-'])
          search (digits,[a*b,...rest],[...rpn,'*'])
          search (digits,[a/b,...rest],[...rpn,'/'])
       } else {
          search (digits,[a*b,...rest],[...rpn,'*'])
          search (digits,[a/b,...rest],[...rpn,'/'])
          search (digits,[a+b,...rest],[...rpn,'+'])
          search (digits,[a-b,...rest],[...rpn,'-'])
        }
      }
      if(stack.length<6) {
        for (const digit of digits) {
          const remain = digits.filter(d => d != digit)
          search (remain, [digit,...stack],[...rpn,digit])
        }
      }
    }

    function infix(rpn) {
      const stack = []
      for (const op of rpn) {
        if(op=='+'||op=='*')
          stack.push(order(stack.pop(),op,stack.pop()))
        else if(op=='-'||op=='/')
          stack.push(`(${stack.pop()}${op}${stack.pop()})`)
        else
          stack.push(`${op}`)
      }
      return stack[0]

      function order(a,op,b) {
        return min(a) < min(b)
          ? `(${a}${op}${b})`
          : `(${b}${op}${a})`
      }

      function min(expr) {
        return expr.match(/\d/g).sort()[0]
      }
    }
  }

</script>
