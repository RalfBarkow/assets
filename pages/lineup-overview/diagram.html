<p><button onclick="draw(event)">draw</button> <span id=counts></span></p>
<div id=result>working</div>

<style>
  th, td, span { text-align:center; font-family: verdana, helvetica, sans; font-size: smaller; }
}
</style>

<script>

  const dup = obj => JSON.parse(JSON.stringify(obj))
  const quote = text => `"${text.replace(/([a-z]) ([A-Z])/g,'$1\n$2')}"`
  const asSlug = (title) => title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()

  let graph = {} // root => [point]
  let forks = new Set()

  let sitemap
  let colored = new Set()

  find()

  async function main() {
    result.innerHTML = `ready`
  }

  async function find(event) {
    let {site} = await frameContext()
    console.log({site})
    sitemap = fetch(`//${site}/system/sitemap.json`).then(res => res.json())
    let lineup = await sources('graph')
    sitemap = await sitemap
    for (let spot of lineup) {
      forks.add(spot.panel.site)
      for (let root in spot.graphData) {
        let points = graph[root] ||= []
        for (let point of spot.graphData[root])
          if (!points.includes(point)) points.push(point)
      }
    }
    counts.innerHTML = `${Object.keys(graph).length} nodes`
    stats()
  }

  function stats() {
    let rows = Object.keys(graph).map(root => {
      let inputs = Object.values(graph).flat().filter(point => point==root).length
      let outputs = graph[root].length
      return `<tr><td>${root}<td>${inputs}<td>${outputs}`
    })
    result.innerHTML = `<table><tr><th>node<th>in<th>out</tr>${rows.join("\n")}`
  }

  function draw(event) {
    console.log('sitemap',sitemap)
    if(!Object.keys(graph).length) return
    let markup = []
    markup.push("node [fillcolor=lightblue]")
    for (let root in graph) {
      let slug = asSlug(root)
      if (!colored.has(root) && sitemap.find(info => info.slug == slug)) {
        markup.push(quote(root))
      }
    }
    markup.push("node [fillcolor=palegreen]")
    for (let root in graph) {
      for (let point of graph[root])
        markup.push(`${quote(root)} -> ${quote(point)}`)
    }
    let text = `digraph { node[shape=box style=filled]\n${markup.join("\n")}\n}`
    let story = [
      {type:'paragraph', text:`We found ${Object.keys(graph).length} nodes in the lineup`},
      {type:'graphviz', text}
    ]
    open({title:`Merged Graphs from Lineup`,story},event.shiftKey,[...forks])
  }


  // U T I L I T I E S

  function sources(topic) {
    const action = 'requestSourceData'
    return new Promise(resolve => {
      let handler = event => {
        let {data} = event
        if (!data.action == action) return
        window.removeEventListener('message',handler)
        resolve(data.sources)
      }
      window.addEventListener('message',handler)
      window.parent.postMessage({action, topic},"*")
    })
  }

  function frameContext() {
    return new Promise(resolve => {
      let handler = event => {
        let {data} = event
        if (!data.action == "frameContext") return
        window.removeEventListener('message',handler)
        resolve(data)
      }
      window.addEventListener('message',handler)
      window.parent.postMessage({action:"sendFrameContext"},"*")
    })
  }

  function open(page, keepLineup=false, forks=[]) {
    let date = Date.now()
    for (let item of page.story) item.id = (Math.random()*10**20).toFixed(0)
    page.journal = [{type:'create', date, item:dup(page)}, ...forks.map(site => ({type:'fork',date,site}))]
    let message = {action: "showResult", page, keepLineup}
    window.parent.postMessage(message, "*")
  }

</script>